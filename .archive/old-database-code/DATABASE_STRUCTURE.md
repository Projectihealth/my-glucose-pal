# CGM Butler æ•°æ®åº“ç»“æ„å›¾

## ğŸ“Š æ•°æ®åº“æ¦‚è§ˆ

```
cgm_butler.db (SQLite)
â”œâ”€â”€ ç”¨æˆ·æ¨¡å— (1 å¼ è¡¨)
â”‚   â””â”€â”€ users
â”‚
â”œâ”€â”€ CGM æ•°æ®æ¨¡å— (3 å¼ è¡¨)
â”‚   â”œâ”€â”€ cgm_readings
â”‚   â”œâ”€â”€ cgm_pattern_actions
â”‚   â””â”€â”€ activity_logs
â”‚
â”œâ”€â”€ å¯¹è¯ç³»ç»Ÿæ¨¡å— (2 å¼ è¡¨)
â”‚   â”œâ”€â”€ conversations (ç»Ÿä¸€å­˜å‚¨ text/voice/video)
â”‚   â””â”€â”€ conversation_analysis
â”‚
â””â”€â”€ è®°å¿†ç³»ç»Ÿæ¨¡å— (3 å¼ è¡¨)
    â”œâ”€â”€ user_memories (çŸ­æœŸè®°å¿†)
    â”œâ”€â”€ user_long_term_memory (é•¿æœŸè®°å¿†)
    â””â”€â”€ user_todos (å¾…åŠäº‹é¡¹)
```

---

## ğŸ”— è¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚
â”‚  (ç”¨æˆ·ä¿¡æ¯è¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                  â”‚
    â”‚                                                  â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cgm_readings    â”‚                      â”‚   activity_logs      â”‚
â”‚  (CGMè¯»æ•°è¡¨)      â”‚                      â”‚   (æ´»åŠ¨æ—¥å¿—è¡¨)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    â”‚
    â”‚ 1:N
    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     conversations                            â”‚
â”‚                   (å¯¹è¯è®°å½•ç»Ÿä¸€è¡¨)                             â”‚
â”‚                                                              â”‚
â”‚  conversation_type:                                          â”‚
â”‚  â”œâ”€ 'gpt_chat'      (æ–‡æœ¬å¯¹è¯)                               â”‚
â”‚  â”œâ”€ 'retell_voice'  (è¯­éŸ³å¯¹è¯)                               â”‚
â”‚  â””â”€ 'tavus_video'   (è§†é¢‘å¯¹è¯)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:1
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ conversation_analysis   â”‚
â”‚   (å¯¹è¯åˆ†æè¡¨)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”‚
         â”‚ 1:N
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   user_memories     â”‚                 â”‚    user_todos        â”‚
â”‚   (çŸ­æœŸè®°å¿†è¡¨)       â”‚                 â”‚   (å¾…åŠäº‹é¡¹è¡¨)        â”‚
â”‚                     â”‚                 â”‚                      â”‚
â”‚ - æ¯æ¬¡å¯¹è¯æ€»ç»“       â”‚                 â”‚ - ä»å¯¹è¯æå–çš„è¡ŒåŠ¨é¡¹  â”‚
â”‚ - æ´å¯Ÿå’Œå‘ç°         â”‚                 â”‚ - æ¯å‘¨ç›®æ ‡è¿½è¸ª        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”‚
         â”‚ N:1 (èšåˆ)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_long_term_memory     â”‚
â”‚   (é•¿æœŸè®°å¿†è¡¨)             â”‚
â”‚                           â”‚
â”‚ - ç”¨æˆ·åå¥½                 â”‚
â”‚ - å¥åº·ç›®æ ‡                 â”‚
â”‚ - ä¹ æƒ¯æ¨¡å¼                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ æ ¸å¿ƒè¡¨è¯¦ç»†è¯´æ˜

### 1. `conversations` - å¯¹è¯ç»Ÿä¸€å­˜å‚¨è¡¨

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒè¡¨,ç»Ÿä¸€å­˜å‚¨ä¸‰ç§ç±»å‹çš„å¯¹è¯:

```sql
conversations
â”œâ”€â”€ conversation_id (PK)
â”œâ”€â”€ user_id (FK â†’ users)
â”œâ”€â”€ conversation_type ('gpt_chat' | 'retell_voice' | 'tavus_video')
â”‚
â”œâ”€â”€ [Tavus è§†é¢‘å¯¹è¯ä¸“ç”¨å­—æ®µ]
â”‚   â”œâ”€â”€ tavus_conversation_id
â”‚   â”œâ”€â”€ tavus_conversation_url
â”‚   â”œâ”€â”€ tavus_replica_id
â”‚   â””â”€â”€ tavus_persona_id
â”‚
â”œâ”€â”€ [Retell è¯­éŸ³å¯¹è¯ä¸“ç”¨å­—æ®µ]
â”‚   â”œâ”€â”€ retell_call_id
â”‚   â”œâ”€â”€ retell_agent_id
â”‚   â”œâ”€â”€ call_status
â”‚   â”œâ”€â”€ call_type
â”‚   â”œâ”€â”€ call_cost
â”‚   â”œâ”€â”€ disconnection_reason
â”‚   â”œâ”€â”€ recording_url
â”‚   â””â”€â”€ transcript_object
â”‚
â”œâ”€â”€ [é€šç”¨å­—æ®µ]
â”‚   â”œâ”€â”€ started_at
â”‚   â”œâ”€â”€ ended_at
â”‚   â”œâ”€â”€ duration_seconds
â”‚   â”œâ”€â”€ status
â”‚   â”œâ”€â”€ transcript (æ ¸å¿ƒå­—æ®µ:å¯¹è¯å†…å®¹)
â”‚   â”œâ”€â”€ conversational_context
â”‚   â””â”€â”€ custom_greeting
â”‚
â””â”€â”€ [å…ƒæ•°æ®]
    â”œâ”€â”€ properties (JSON)
    â””â”€â”€ metadata (JSON)
```

**å…³é”®ç‰¹æ€§**:
- âœ… ä¸‰ç§å¯¹è¯ç±»å‹ç»Ÿä¸€å­˜å‚¨
- âœ… æ¯æ¡è®°å½•éƒ½æœ‰ `transcript` å­—æ®µ
- âœ… é€šè¿‡ `conversation_type` åŒºåˆ†å¯¹è¯ç±»å‹
- âœ… ç±»å‹ç‰¹å®šå­—æ®µå¯ä¸º NULL

---

### 2. è®°å¿†ç³»ç»Ÿä¸‰å¼ è¡¨çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¯¹è¯ç»“æŸå                                 â”‚
â”‚                         â†“                                     â”‚
â”‚              MemoryService.process_conversation()            â”‚
â”‚                         â†“                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚         â”‚                               â”‚                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚ çŸ­æœŸè®°å¿†  â”‚                    â”‚ TODOæå– â”‚             â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                               â”‚                    â”‚
â”‚         â–¼                               â–¼                    â”‚
â”‚  user_memories                   user_todos                  â”‚
â”‚  (æ¯æ¬¡å¯¹è¯ä¸€æ¡)                   (æ¯ä¸ªTODOä¸€æ¡)              â”‚
â”‚                                                              â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”‚ (å®šæœŸèšåˆ)                                          â”‚
â”‚         â–¼                                                    â”‚
â”‚  user_long_term_memory                                       â”‚
â”‚  (æ¯ä¸ªç”¨æˆ·ä¸€æ¡,æŒç»­æ›´æ–°)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµ**:
1. **å¯¹è¯ç»“æŸ** â†’ ä¿å­˜åˆ° `conversations`
2. **MemoryService å¤„ç†**:
   - æå–æœ¬æ¬¡å¯¹è¯æ€»ç»“ â†’ `user_memories`
   - æå–è¡ŒåŠ¨é¡¹ â†’ `user_todos`
   - æ›´æ–°é•¿æœŸä¹ æƒ¯/ç›®æ ‡ â†’ `user_long_term_memory`

---

## ğŸ” æŸ¥è¯¢ç¤ºä¾‹

### è·å–ç”¨æˆ·æœ€è¿‘çš„å¯¹è¯å’Œè®°å¿†

```sql
-- è·å–ç”¨æˆ·æœ€è¿‘ 7 å¤©çš„æ‰€æœ‰å¯¹è¯
SELECT 
    conversation_id,
    conversation_type,
    started_at,
    duration_seconds
FROM conversations
WHERE user_id = 'user_001'
  AND started_at >= datetime('now', '-7 days')
ORDER BY started_at DESC;

-- è·å–ç”¨æˆ·æœ€è¿‘çš„çŸ­æœŸè®°å¿†
SELECT 
    summary,
    key_topics,
    created_at
FROM user_memories
WHERE user_id = 'user_001'
  AND created_at >= datetime('now', '-7 days')
ORDER BY created_at DESC;

-- è·å–ç”¨æˆ·æœ¬å‘¨çš„ TODO
SELECT 
    title,
    category,
    target_count,
    current_count,
    status
FROM user_todos
WHERE user_id = 'user_001'
  AND week_start = date('now', 'weekday 0', '-7 days')
ORDER BY created_at DESC;
```

### æŒ‰å¯¹è¯ç±»å‹ç»Ÿè®¡

```sql
-- ç»Ÿè®¡æ¯ç§å¯¹è¯ç±»å‹çš„æ•°é‡
SELECT 
    conversation_type,
    COUNT(*) as count,
    AVG(duration_seconds) as avg_duration
FROM conversations
WHERE user_id = 'user_001'
GROUP BY conversation_type;
```

---

## ğŸ“‚ æ–‡ä»¶ç»„ç»‡ç»“æ„

```
apps/backend/cgm_butler/database/
â”‚
â”œâ”€â”€ ğŸ“„ schema.py                    â† ç»Ÿä¸€çš„ Schema å®šä¹‰ (æ–°å¢)
â”œâ”€â”€ ğŸ“„ README.md                    â† æ•°æ®åº“ä½¿ç”¨æ–‡æ¡£ (æ–°å¢)
â”œâ”€â”€ ğŸ“„ DATABASE_STRUCTURE.md        â† æœ¬æ–‡ä»¶:ç»“æ„å›¾å’Œå…³ç³»è¯´æ˜
â”‚
â”œâ”€â”€ ğŸ“„ conversation_manager.py      â† å¯¹è¯å’Œè®°å¿†çš„ CRUD æ“ä½œ
â”œâ”€â”€ ğŸ“„ cgm_database.py              â† CGM æ•°æ®çš„ CRUD æ“ä½œ
â”‚
â”œâ”€â”€ ğŸ“„ setup_database.py            â† åˆå§‹åŒ–æ•°æ®åº“ + æµ‹è¯•æ•°æ®
â”œâ”€â”€ ğŸ“„ migration_add_conversations.py
â”œâ”€â”€ ğŸ“„ migration_add_memory_tables.py
â”œâ”€â”€ ğŸ“„ migration_add_voice_chat_fields.py
â”‚
â””â”€â”€ ğŸ’¾ cgm_butler.db                â† å®é™…æ•°æ®åº“æ–‡ä»¶
```

---

## âœ… æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€ä½¿ç”¨ schema.py å®šä¹‰è¡¨ç»“æ„
```python
from database.schema import create_all_tables
import sqlite3

conn = sqlite3.connect('cgm_butler.db')
create_all_tables(conn)
conn.close()
```

### 2. ä½¿ç”¨ ConversationManager æ“ä½œæ•°æ®
```python
from database.conversation_manager import ConversationManager

manager = ConversationManager()

# ä¿å­˜å¯¹è¯
conv_id = manager.save_gpt_conversation(...)

# ä¿å­˜è®°å¿†
memory_id = manager.save_memory(...)

# ä¿å­˜ TODO
todo_ids = manager.save_todos(...)
```

### 3. æŸ¥è¯¢æ—¶ä½¿ç”¨ç´¢å¼•
æ‰€æœ‰é«˜é¢‘æŸ¥è¯¢å­—æ®µéƒ½å·²å»ºç«‹ç´¢å¼•:
- `user_id` (æ‰€æœ‰è¡¨)
- `timestamp` / `created_at` (æ—¶é—´èŒƒå›´æŸ¥è¯¢)
- `conversation_type` (å¯¹è¯ç±»å‹è¿‡æ»¤)

---

## ğŸ¯ æ€»ç»“

ç°åœ¨ä½ æœ‰äº†:

1. âœ… **ç»Ÿä¸€çš„ Schema å®šä¹‰** (`schema.py`) - æ‰€æœ‰è¡¨ç»“æ„é›†ä¸­ç®¡ç†
2. âœ… **æ¸…æ™°çš„æ–‡æ¡£** (`README.md`) - æ¯å¼ è¡¨çš„è¯¦ç»†è¯´æ˜
3. âœ… **å¯è§†åŒ–ç»“æ„å›¾** (æœ¬æ–‡ä»¶) - è¡¨å…³ç³»å’Œæ•°æ®æµ
4. âœ… **å®Œæ•´çš„æ•°æ®æµ** - ä»å¯¹è¯åˆ°è®°å¿†åˆ° TODO çš„é—­ç¯

**æ•°æ®åº“ä½ç½®**: `apps/backend/cgm_butler/database/cgm_butler.db`

**æ ¸å¿ƒç‰¹æ€§**:
- ä¸‰ç§å¯¹è¯ç±»å‹ç»Ÿä¸€å­˜å‚¨åœ¨ `conversations` è¡¨
- æ¯æ¬¡å¯¹è¯ç»“æŸè‡ªåŠ¨ç”Ÿæˆ memory å’Œ todo
- æ”¯æŒæŸ¥è¯¢æœ€è¿‘ N å¤©çš„è®°å¿†ç”¨äºä¸‹æ¬¡å¯¹è¯ context

